name: ci

on:
  push:
    branches: [ "main", "*" ]
    paths:
      - "app_admin.py"
      - ".github/workflows/ci.yml"
      - "requirements.txt"
  pull_request:
    branches: [ "main" ]
    paths:
      - "app_admin.py"
      - ".github/workflows/ci.yml"
      - "requirements.txt"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-guards:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install "ruff==0.14.2"

      - name: Ruff lint
        run: |
          ruff check --output-format=github .

      - name: Ruff format (check only)
        run: |
          ruff format --check .

      - name: Drift proof â€” app_admin.py hash & line count
        id: drift-proof
        run: |
          set -euo pipefail
          f="app_admin.py"
          if [[ ! -f "$f" ]]; then
            echo "::error::Missing $f at repo root"; exit 1
          fi
          sha=$(sha256sum "$f" | awk '{print $1}')
          lines=$(wc -l < "$f")
          bytes=$(wc -c < "$f")
          # Sanity thresholds (tune as needed)
          [[ $lines -ge 500 ]] || { echo "::error::$f too short: $lines lines"; exit 1; }
          [[ $bytes -ge 20000 ]] || { echo "::error::$f too small: $bytes bytes"; exit 1; }
          echo "SHA256: $sha"
          echo "LINES : $lines"
          echo "BYTES : $bytes"
          echo "app_admin_sha256=$sha" >> "$GITHUB_OUTPUT"
          echo "app_admin_lines=$lines" >> "$GITHUB_OUTPUT"
          echo "app_admin_bytes=$bytes" >> "$GITHUB_OUTPUT"
