#!/usr/bin/env bash
set -euo pipefail
checked=0
while read -r local_ref local_sha remote_ref remote_sha; do
  if [ "$remote_ref" = "refs/heads/main" ]; then
    checked=1
    out="$(hcrsync || true)"
    echo "$out"; echo
    if ! grep -q '^OK: Local commit matches origin/main\.$' <<<"$out"; then
      echo "ABORT: local != origin/main. Run: git switch main && git pull --ff-only"
      exit 1
    fi
  fi
done
if [ $checked -eq 0 ]; then
  branch="$(git rev-parse --abbrev-ref HEAD)"
  if [ "$branch" = "main" ]; then
    out="$(hcrsync || true)"; echo "$out"; echo
    if ! grep -q '^OK: Local commit matches origin/main\.$' <<<"$out"; then
      echo "ABORT: local != origin/main. Run: git switch main && git pull --ff-only"
      exit 1
    fi
  fi
fi
