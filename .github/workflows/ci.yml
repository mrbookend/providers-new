name: ci

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # REQUIRED 1/3 — quick file facts on every run
  file-facts:
    name: file-facts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Report file facts
        shell: bash
        run: |
          set -euo pipefail
          f="app_admin.py"
          if [[ -f "$f" ]]; then
            sha256sum "$f" | awk '{print "sha256:", $1}'
            wc -l "$f" | awk '{print "lines :", $1}'
            echo "HEAD: $(git rev-parse HEAD)"
          else
            echo "::warning::$f missing"
          fi

  # REQUIRED 2/3 — Ruff lint & format guards (CI pins 0.14.2)
  lint-and-guards:
    name: lint-and-guards
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Ruff
        run: pip install "ruff==0.14.2"
      - name: Syntax sanity (py_compile)
        run: python -m py_compile app_admin.py || true
      - name: Ruff lint
        run: ruff check --output-format=github .
      - name: Ruff format (check only)
        run: ruff format --check .

  # REQUIRED 3/3 — drift view (base vs head file hash/lines on PRs)
  hcr-drift:
    name: hcr-drift
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for base/head)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Show base/head app_admin.py facts (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ github.event.pull_request.base.sha }}"
          HEAD="${{ github.sha }}"
          echo "BASE: $BASE"
          echo "HEAD: $HEAD"

          show_facts() {
            local ref="$1"
            if git show "$ref:app_admin.py" >/dev/null 2>&1; then
              local h l
              h=$(git show "$ref:app_admin.py" | sha256sum | awk '{print $1}')
              l=$(git show "$ref:app_admin.py" | wc -l | awk '{print $1}')
              echo "$2.sha256: $h"
              echo "$2.lines : $l"
            else
              echo "$2: app_admin.py missing"
            fi
          }

          show_facts "$BASE" "base"
          show_facts "$HEAD" "head"
