name: ci

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-guards:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.13"

      - name: Install Ruff (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install "ruff==0.14.2"

      # Lint + format guards (kept as checks, not auto-fix)
      - name: Ruff lint
        run: ruff check --output-format=github .

      - name: Ruff format (check only)
        run: ruff format --check .

      # Publish file facts so we can verify GitHub is source of truth
      - name: app_admin.py facts
        id: facts
        shell: bash
        run: |
          set -euo pipefail
          f="app_admin.py"
          if [[ ! -f "$f" ]]; then
            echo "::error ::Missing $f"
            exit 1
          fi
          sha=$(python - <<'PY'
from pathlib import Path
import hashlib
b = Path("app_admin.py").read_bytes()
print(hashlib.sha256(b).hexdigest())
PY
)
          lines=$(wc -l < "$f" | tr -d ' ')
          echo "sha256=$sha" >> "$GITHUB_OUTPUT"
          echo "lines=$lines" >> "$GITHUB_OUTPUT"
          {
            echo "### app_admin.py facts"
            echo ""
            echo "- sha256: \`$sha\`"
            echo "- lines: $lines"
            echo "- path: app_admin.py"
          } >> "$GITHUB_STEP_SUMMARY"

      # Optional: hard-fail if file unexpectedly changes during the job
      - name: Reconfirm file unchanged within job
        shell: bash
        run: |
          set -euo pipefail
          sha_now=$(python - <<'PY'
from pathlib import Path
import hashlib
b = Path("app_admin.py").read_bytes()
print(hashlib.sha256(b).hexdigest())
PY
)
          if [[ "$sha_now" != "${{ steps.facts.outputs.sha256 }}" ]]; then
            echo "::error ::app_admin.py mutated during job (sha drift)"
            exit 1
          fi
