on:
  push:
    branches: [ "**" ]
    paths: [ "app_admin.py", ".github/workflows/ci.yml" ]
  pull_request:
    branches: [ "**" ]
    paths: [ "app_admin.py", ".github/workflows/ci.yml" ]
  workflow_dispatch: {}


permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  file-facts:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4

      - name: Collect app_admin.py facts
        id: facts
        shell: bash
        run: |
          set -euo pipefail
          f="app_admin.py"
          if [[ -f "$f" ]]; then
            sha256=$(sha256sum "$f" | awk '{print $1}')
            md5=$(md5sum "$f" | awk '{print $1}')
            lines=$(wc -l < "$f" | tr -d ' ')
            size=$(wc -c < "$f" | tr -d ' ')
            echo "sha256=$sha256" >> "$GITHUB_OUTPUT"
            echo "md5=$md5" >> "$GITHUB_OUTPUT"
            echo "lines=$lines" >> "$GITHUB_OUTPUT"
            echo "size=$size" >> "$GITHUB_OUTPUT"
            {
              echo "### app_admin.py facts"
              echo "- sha256: \`$sha256\`"
              echo "- md5: \`$md5\`"
              echo "- lines: $lines"
              echo "- size: $size bytes"
              echo "- path: $f"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "app_admin.py not found in repo root." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload file facts artifact (optional)
        if: ${{ steps.facts.outputs.sha256 != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: app_admin-file-facts
          path: app_admin.py

      - name: Comment PR with file facts
        if: ${{ github.event_name == 'pull_request' && steps.facts.outputs.sha256 != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "## app_admin.py facts",
              `- sha256: \`${{ steps.facts.outputs.sha256 }}\``,
              `- md5: \`${{ steps.facts.outputs.md5 }}\``,
              `- lines: ${{ steps.facts.outputs.lines }}`,
              `- size: ${{ steps.facts.outputs.size }} bytes`,
            ].join("\n");
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });
